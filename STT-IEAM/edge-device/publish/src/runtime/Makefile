#
# Makefile : Runtime - Watson Speech-To-Text (STT)
# ------------------------------------------------

# Check all necessary environment variables
-include ../../../env.check.mk

export ARCH ?= $(shell hzn architecture)

# Import variables from hzn.json (file is generated by last target in this file)
-include .hzn.json.tmp.mk

all: build-image push-image publish-service deploy-policy

# Build the docker container image
build-image:
	docker build . -t ${CR_IBM_IMAGE_BASE}_${ARCH}:${SERVICE_VERSION} -f Dockerfile.${ARCH}

# Push the docker container image in container registry
push-image:
	docker login -u ${CR_IBM_USERNAME} -p ${CR_APP_API_KEY_RW_PUSH} ${CR_IBM_HOST}
	docker push ${CR_IBM_IMAGE_BASE}_${ARCH}:${SERVICE_VERSION}

# Publish IEAM service for the image
publish-service:
	docker login -u ${CR_IBM_USERNAME} -p ${CR_APP_API_KEY_RO_PULL} ${CR_IBM_HOST}
	hzn exchange service publish -O -f horizon/service-definition.json --pull-image -r "${CR_IBM_HOST}:${CR_IBM_USERNAME}:${CR_APP_API_KEY_RO_PULL}" 

deploy-policy:
	hzn exchange deployment addpolicy -f horizon/deploy-policy.json deploy-${EDGE_OWNER}.${EDGE_DEPLOY}.${IMAGE_NAME}_${ARCH}

# This imports the variables from hzn.json
.hzn.json.tmp.mk: horizon/hzn.json
	@ hzn util configconv -f $< > $@
